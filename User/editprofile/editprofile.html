<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodHub - Edit Profile</title>
    <link rel="stylesheet" href="../style.css" />
  </head>

  <body>
    <!-- Edit Profile Container -->
    <div class="auth-container">
      <div class="auth-box">
        <div class="auth-header">
          <h1>Your Profile</h1>
          <p>Update your account details below</p>
        </div>

        <form id="editProfileForm" class="auth-form">
          <!-- Name Field -->
          <div class="form-group">
            <label for="name">
              Full Name
              <span class="required">*</span>
            </label>
            <input type="text" id="name" name="name" placeholder="Enter your full name" required />
            <span class="error-message" id="nameError"></span>
          </div>

          <!-- Email Field (read-only) -->
          <div class="form-group">
            <label for="email">
              Email Address
              <span class="required">*</span>
            </label>
            <input type="email" id="email" name="email" disabled />
            <span class="field-hint">Email cannot be changed</span>
          </div>

          <!-- Phone Field -->
          <div class="form-group">
            <label for="phone">
              Phone Number
              <span class="required">*</span>
            </label>
            <input type="tel" id="phone" name="phone" placeholder="+65 1234 5678" required />
            <span class="error-message" id="phoneError"></span>
          </div>

          <!-- Password Fields (optional) -->
          <div class="form-group">
            <label for="password">New Password (optional)</label>
            <div class="password-input-wrapper">
              <input
                type="password"
                id="password"
                name="password"
                placeholder="Leave blank to keep current" />
              <button type="button" class="toggle-password" data-target="password">üëÅÔ∏è</button>
            </div>
            <span class="password-hint">Must be at least 8 characters</span>
            <span class="error-message" id="passwordError"></span>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <div class="password-input-wrapper">
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                placeholder="Re-enter new password" />
              <button type="button" class="toggle-password" data-target="confirmPassword">
                üëÅÔ∏è
              </button>
            </div>
            <span class="error-message" id="confirmPasswordError"></span>
          </div>

          <!-- Submit -->
          <button type="submit" class="auth-submit-btn">Save Changes</button>
        </form>

        <!-- Footer -->
        <div class="auth-footer">
          <p>
            Done editing?
            <a href="../homepage/menu.php" class="link">Back to Menu</a>
          </p>
        </div>
      </div>
    </div>

    <script>
      // ------------------- VALIDATION HELPERS -------------------
      function showError(errorId, message, inputId) {
        const error = document.getElementById(errorId);
        error.textContent = message;
        error.classList.add("show");
        if (inputId) document.getElementById(inputId).classList.add("error");
      }

      function clearErrors() {
        document.querySelectorAll(".error-message").forEach((e) => {
          e.textContent = "";
          e.classList.remove("show");
        });
        document.querySelectorAll("input.error").forEach((e) => e.classList.remove("error"));
      }

      function isValidPhone(phone) {
        // fixed regex (no double escaping)
        const phoneRegex = /^[\d\s\+\-\(\)]+$/;
        return phoneRegex.test(phone) && phone.replace(/\D/g, "").length >= 8;
      }

      // ------------------- AUTH CHECK -------------------
      let currentUser = null;
      if (localStorage.getItem("isLoggedIn") !== "true") {
        // user not logged in -> send to login
        window.location.href = "../login/login.html";
      }

      try {
        currentUser = JSON.parse(localStorage.getItem("user") || "{}");
      } catch {
        currentUser = {};
      }

      if (!currentUser.email) {
        window.location.href = "../login/login.html";
      }

      // ------------------- FETCH PROFILE FROM SERVER -------------------
      // pulls latest user info (name, phone) from DB using their email
      fetch("editprofile.php?email=" + encodeURIComponent(currentUser.email))
        .then((res) => res.json())
        .then((data) => {
          if (!data.success) {
            alert("Unable to load profile: " + data.message);
            window.location.href = "../login/login.html";
            return;
          }

          document.getElementById("name").value = data.user.name || "";
          document.getElementById("email").value = data.user.email || "";
          document.getElementById("phone").value = data.user.phone || "";

          currentUser = data.user; // keep synced
        })
        .catch((err) => {
          console.error(err);
          alert("Error loading profile.");
          window.location.href = "../login/login.html";
        });

      // ------------------- PASSWORD TOGGLE -------------------
      document.querySelectorAll(".toggle-password").forEach((button) => {
        button.addEventListener("click", function () {
          const target = document.getElementById(this.dataset.target);
          if (target.type === "password") {
            target.type = "text";
            this.textContent = "üôà";
          } else {
            target.type = "password";
            this.textContent = "üëÅÔ∏è";
          }
        });
      });

      // ------------------- FORM SUBMIT -------------------
      document.getElementById("editProfileForm").addEventListener("submit", (e) => {
        e.preventDefault();
        clearErrors();

        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        let valid = true;

        // name validation
        if (name.length < 2) {
          showError("nameError", "Name must be at least 2 characters", "name");
          valid = false;
        }

        // phone validation
        if (!isValidPhone(phone)) {
          showError("phoneError", "Enter a valid phone number", "phone");
          valid = false;
        }

        // password validation (OPTIONAL)
        // only check password rules if the user typed something
        const wantsPasswordChange = password !== "" || confirmPassword !== "";

        if (wantsPasswordChange) {
          if (password.length < 8) {
            showError("passwordError", "Password must be at least 8 characters", "password");
            valid = false;
          }
          if (password !== confirmPassword) {
            showError("confirmPasswordError", "Passwords do not match", "confirmPassword");
            valid = false;
          }
        }

        if (!valid) return;

        // build payload for backend
        const payload = {
          email,
          name,
          phone,
        };

        // only send password if user is changing it
        if (wantsPasswordChange) {
          payload.password = password;
        }

        fetch("../editprofile/editprofile.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.success) {
              alert("Update failed: " + data.message);
              return;
            }

            // sync localStorage with new info
            const updatedUser = {
              ...currentUser,
              name: data.user.name,
              phone: data.user.phone,
            };

            if (wantsPasswordChange) {
              // this is only for client-side convenience.
              // (DB is storing the hashed password, not this)
              updatedUser.password = password;
            }

            localStorage.setItem("user", JSON.stringify(updatedUser));

            alert("Profile updated successfully!");
            window.location.href = "../homepage/menu.php";
          })
          .catch((err) => {
            console.error(err);
            alert("Unexpected error updating profile.");
          });
      });
    </script>
  </body>
</html>

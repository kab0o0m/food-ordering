<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodHub - Admin Orders</title>

    <!-- Optional global styles -->
    <link rel="stylesheet" href="../User/style.css" />

    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">FoodHub Admin</div>
      <ul class="nav-links">
        <li><a href="../Admin/admin.html">Admin</a></li>
        <li><a href="../Admin/sales-report/sales-report.html">Sales Report</a></li>
        <li><a href="../Admin/product-management/product-management.php">Products</a></li>
      </ul>
      <button
        id="exitBtn"
        class="account-btn"
        onclick="window.location.href='../User/homepage/menu.php'">
        EXIT ADMIN
      </button>
    </nav>

    <div class="page">
      <div class="admin-bar">
        <div>
          <h1 class="title">All Orders</h1>
          <div class="tabs">
            <button class="tab active" data-filter="all">All</button>
            <button class="tab" data-filter="Pending">Pending</button>
            <button class="tab" data-filter="Completed">Completed</button>
          </div>
        </div>
      </div>
      <div id="orders-list"></div>
    </div>

    <script>
      // ---------- state ----------
      let ALL_ORDERS = [];
      let CURRENT_FILTER = "all";

      // ---------- utils ----------
      const money = (n) => "$" + Number(n ?? 0).toFixed(2);
      const statusBadgeClass = (s) =>
        String(s || "").toLowerCase() === "completed"
          ? "status-badge status-completed"
          : "status-badge status-pending";

      function filterOrders() {
        return ALL_ORDERS.filter((o) =>
          CURRENT_FILTER === "all" ? true : o.order_status === CURRENT_FILTER
        );
      }

      function render() {
        const list = document.getElementById("orders-list");
        list.innerHTML = "";
        const orders = filterOrders();

        if (!orders.length) {
          list.innerHTML = `<div class="empty">No orders found.</div>`;
          return;
        }

        orders.forEach((order) => {
          const items = Array.isArray(order.items) ? order.items : [];
          const card = document.createElement("div");
          card.className = "order-card";
          card.innerHTML = `
          <div class="order-top">
            <div><div class="order-id">Order #${order.id}</div></div>
            <div class="right-top"><span class="${statusBadgeClass(order.order_status)}">${
            order.order_status || "Pending"
          }</span></div>
          </div>

          <div class="order-body">
            <div class="items">
              ${
                items.length
                  ? items
                      .map(
                        (it) => `
                  <div class="item-row">
                    <div class="item-name">${it.product_name}</div>
                    <div class="qty"><span class="muter">Qty</span> ${it.quantity}</div>
                    <div class="price"><span class="muter">Price</span> ${money(
                      it.unit_price
                    )}</div>
                    <div class="line"><span class="muter">Total</span> ${money(it.line_total)}</div>
                  </div>
                `
                      )
                      .join("")
                  : `<div class="item-row"><div class="item-name">No items</div><div></div><div></div><div></div></div>`
              }
            </div>

            <div class="info-box">
              <div class="info-row"><span class="label">Customer</span><span>${
                order.customer_name || "-"
              }</span></div>
              <div class="info-row"><span class="label">Email</span><span>${
                order.customer_email || "-"
              }</span></div>
              <div class="info-row"><span class="label">Phone</span><span>${
                order.customer_phone || "-"
              }</span></div>
              <div class="info-row total"><span>Total</span><span>${money(order.total)}</span></div>

              <div class="action-row">
                <button class="mark-btn" data-id="${order.id}" ${
            String(order.order_status).toLowerCase() === "completed" ? "disabled" : ""
          }>
                  ${
                    String(order.order_status).toLowerCase() === "completed"
                      ? "Completed"
                      : "Ready for Collection"
                  }
                </button>
              </div>
            </div>
          </div>
        `;

          const btn = card.querySelector(".mark-btn");
          if (btn && !btn.disabled) {
            btn.addEventListener("click", () => updateStatus(order.id, "Completed", btn));
          }
          document.getElementById("orders-list").appendChild(card);
        });
      }

      function setActiveTab(filter) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.toggle("active", t.dataset.filter === filter));
      }

      // ---------- API calls (single endpoint admin.php) ----------
      async function fetchOrders() {
        const res = await fetch("admin.php", { credentials: "include" });
        if (res.status === 401) {
          await Swal.fire({
            icon: "warning",
            title: "Login required",
            text: "Please log in to continue.",
          });
          location.href = "../login/login.html";
          return;
        }
        if (res.status === 403) {
          await Swal.fire({ icon: "error", title: "Access denied", text: "Admin only area." });
          location.href = "../User/homepage/menu.php";
          return;
        }
        const data = await res.json().catch(() => ({}));
        if (!data.success) {
          throw new Error(data.message || "Failed to fetch");
        }
        ALL_ORDERS = data.orders || [];
        render();
      }

      function updateStatus(orderId, status, btnRef) {
        if (!orderId) return;
        btnRef.disabled = true;
        btnRef.textContent = "Updatingâ€¦";

        fetch("update_order_status.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order_id: orderId, status }),
        })
          .then((r) => r.json())
          .then((d) => {
            if (!d.success) {
              alert(d.message || "Failed to update order status");
              btnRef.disabled = false;
              btnRef.textContent = "Ready For Collection";
              return;
            }
            // Optimistic update
            const idx = ALL_ORDERS.findIndex((o) => o.id == orderId);
            if (idx > -1) ALL_ORDERS[idx].order_status = "Completed";
            render();
          })
          .catch((err) => {
            console.error(err);
            alert("Unexpected error.");
            btnRef.disabled = false;
            btnRef.textContent = "Ready For Collection";
          });
      }
      // ---------- events ----------
      document.querySelectorAll(".tab").forEach((t) => {
        t.addEventListener("click", () => {
          CURRENT_FILTER = t.dataset.filter;
          setActiveTab(CURRENT_FILTER);
          render();
        });
      });

      // ---------- init ----------
      fetchOrders().catch((err) => {
        console.error("Error fetching orders:", err);
        Swal.fire({ icon: "error", title: "Error", text: "Error loading orders." });
        document.getElementById(
          "orders-list"
        ).innerHTML = `<div class="empty">Error loading orders.</div>`;
      });
    </script>
  </body>
</html>
